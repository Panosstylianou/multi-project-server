<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logging in...</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
  <div class="text-center">
    <div class="spinner mx-auto mb-6"></div>
    <h1 class="text-2xl font-bold mb-2">Logging you in...</h1>
    <p id="status" class="text-gray-400">Authenticating with your credentials</p>
    <p id="error" class="text-red-400 mt-4 hidden"></p>
    <button id="manual-login" class="mt-6 px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg hidden">
      Login Manually
    </button>
  </div>

  <script>
    // Auto-login script for PocketBase admin panel
    async function autoLogin() {
      try {
        // Get project ID from URL params
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('projectId');
        const projectDomain = params.get('domain');

        if (!projectId || !projectDomain) {
          showError('Missing project information. Please use the dashboard to access databases.');
          return;
        }

        // Step 1: Get credentials from backend API
        document.getElementById('status').textContent = 'Fetching credentials...';
        
        let credentials;
        try {
          // Try to get credentials from the backend API
          const apiBase = window.location.origin;
          const credsResponse = await fetch(`${apiBase}/api/projects/${projectId}/auto-login-url`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include', // Include cookies for auth
          });

          const credsData = await credsResponse.json();
          
          if (credsData.success && credsData.data?.token) {
            // Backend already authenticated and gave us a token
            const token = credsData.data.token;
            document.getElementById('status').textContent = 'Login successful! Redirecting...';
            
            // Redirect to admin panel with token in hash
            // PocketBase admin will check for token in hash and use it
            setTimeout(() => {
              window.location.href = `https://${projectDomain}/_/#token=${token}`;
            }, 500);
            return;
          } else if (credsData.data?.adminUrl) {
            // Backend has credentials but couldn't authenticate
            // Fall through to direct authentication
            credentials = {
              email: 'hello@oceannet.dev', // Default unified credentials
              password: 'BetterMapRules8'
            };
          } else {
            throw new Error('Could not get credentials from API');
          }
        } catch (apiError) {
          console.log('API fetch failed, using default credentials:', apiError);
          // Fallback to default unified credentials
          credentials = {
            email: 'hello@oceannet.dev',
            password: 'BetterMapRules8'
          };
        }

        // Step 2: Authenticate directly with PocketBase
        document.getElementById('status').textContent = 'Authenticating with PocketBase...';

        let authSuccess = false;
        let pbToken = null;

        // Try the standard admin auth endpoint first
        try {
          let authResponse = await fetch(`https://${projectDomain}/api/admins/auth-with-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              identity: credentials.email,
              password: credentials.password
            }),
            credentials: 'include', // Include cookies
          });

          // If 404, try the alternative endpoint (some PocketBase versions use collections)
          if (!authResponse.ok && authResponse.status === 404) {
            console.log('Trying alternative auth endpoint...');
            authResponse = await fetch(`https://${projectDomain}/api/collections/_superusers/auth-with-password`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                identity: credentials.email,
                password: credentials.password
              }),
              credentials: 'include',
            });
          }

          if (authResponse.ok) {
            const authData = await authResponse.json();
            if (authData.token) {
              pbToken = authData.token;
              authSuccess = true;
            }
          } else {
            const errorText = await authResponse.text();
            console.error('Auth failed:', authResponse.status, errorText);
          }
        } catch (e) {
          console.error('Authentication failed:', e);
        }

        if (!authSuccess || !pbToken) {
          // Authentication failed - show error and redirect for manual login
          document.getElementById('status').textContent = 'Auto-login failed';
          document.getElementById('error').textContent = 
            `Could not authenticate automatically. Opening admin panel for manual login.\n\nEmail: ${credentials.email}`;
          document.getElementById('error').classList.remove('hidden');
          
          setTimeout(() => {
            window.location.href = `https://${projectDomain}/_/`;
          }, 3000);
          return;
        }

        // Step 3: Success! Now redirect to admin panel
        // Note: Due to CORS restrictions, we can't directly set localStorage for PocketBase admin
        // So we'll redirect and the user will be automatically logged in if PocketBase checks the URL
        // Otherwise, they'll see the login form (but credentials are verified to work)
        
        document.getElementById('status').textContent = 'Login verified! Opening admin panel...';
        
        const adminUrl = `https://${projectDomain}/_/`;
        
        // Store credentials in sessionStorage as backup (for potential future use)
        sessionStorage.setItem(`pb_auth_${projectDomain}`, JSON.stringify({
          token: pbToken,
          email: credentials.email,
          timestamp: Date.now()
        }));
        
        // Redirect to admin panel
        // PocketBase admin will check for auth in localStorage
        // If not found, user will see login form but we've verified credentials work
        setTimeout(() => {
          window.location.href = adminUrl;
        }, 1000);

      } catch (error) {
        console.error('Auto-login error:', error);
        showError(`Auto-login failed: ${error.message}. Opening admin panel for manual login...`);
        
        const params = new URLSearchParams(window.location.search);
        const projectDomain = params.get('domain');
        
        if (projectDomain) {
          setTimeout(() => {
            window.location.href = `https://${projectDomain}/_/`;
          }, 2000);
        }
      }
    }

    function showError(message) {
      document.getElementById('error').textContent = message;
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('manual-login').classList.remove('hidden');
      
      document.getElementById('manual-login').onclick = () => {
        const params = new URLSearchParams(window.location.search);
        const projectDomain = params.get('domain');
        if (projectDomain) {
          window.location.href = `https://${projectDomain}/_/`;
        }
      };
    }

    // Start auto-login when page loads
    autoLogin();
  </script>
</body>
</html>

